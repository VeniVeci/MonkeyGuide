# 怎么进行代码梳理比较高效

### 代码也会发霉

会发霉的不只是食物，代码也会。我们通常称为腐化。腐化的过程每天都在发生，一个紧急需求，一个新同事加入，一个变态的问题修复，一个共建项目，等等。腐化，是永远无法避免的，就像宇宙的熵增不可逆一样。面对腐化，架构师往往会加上一个防腐层。如果你的系统还没有防腐层，赶紧考虑考虑。即便有防腐层，也招架不住岁月的摧残，就像头上那日渐稀少的秀发，这就是命啊。

所以，我们需要重构。逆熵增需要做大量的功，要对混乱的代码重新梳理，使其恢复条理清晰、架构分明的优良状态。

### 梳理，还是梳理

重构前花大量时间对历史逻辑做梳理，而且要细致。古人曰“工欲善其事，必先利其器”。梳理好的逻辑就是重构的指路明灯。哪些要丢弃，哪些要优化，哪些要重构，哪些要产品重新定，哪些是风险点，在梳理好后就基本明了了。梳理带来的不只是逻辑的浮现，可能还有架构的方向。通过梳理，能够明确发现业务逻辑，甚至可以定义出新的领域模型、值、事件等。想想银河纪元时代，拿着银河系实时星图作战，就知道梳理有多重要了。

### 架构，以终为始

既然做重构了，架构方面就要好好设计。尽量摒弃错综复杂的历史逻辑，设计新的架构方案。以提高研发效率、降低维护成本为最终目标，所有的重构设计都围绕着这个目标展开。没有什么是不能改的，如果不能，那就加两个更牛逼的程序员。如果重构后还保留一坨屎一样的遗留代码，真不知道重构的意义是什么。重构就是要以终为始，在新的架构设计中，让遗留代码重新投胎以获得新的生命。

### 改善，代码重构

优秀的程序员是需要不定期对已有代码做或多或少的重构的。在《重构 改善既有代码的设计》一书中，作者已经给了很多重构的具体方法。重复代码抽出、过长函数拆分、模型重新设计、封装字段、封装集合、以State/Strategy取代类型码、方法移动位置等诸多技巧，这里就不展开了。我觉得每个程序员都应该好好学习下这本书，然后深入实践下代码级重构。正如书评所说“虽不应翻着重构手册干活，但需对本书中提到的70多个重构方法成竹在胸”。

# 怎么看源代码

作者：岳武
链接：https://www.zhihu.com/question/22129281/answer/20392860
来源：知乎
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

* 不要一上来就啃源代码，去搜索和代码对应的『代码架构图』和『开发者手册』，后者会提供代码的设计思路和很多概念的说明，还会将代码中的注释进行整理汇总，非常有用。当我看了2天的代码，即将要崩溃时，[@huha](//www.zhihu.com/people/06dd4001c495584863a9a925b6465a18)

  找到了『数据流图』和『开发者手册』。
* 在LinuxCNC的根目录下有directory.map，是为代码的组织框架，根据这个，可以快速定位到核心的代码所在的文件夹。
* LinuxCNC的核心代码有2个文件夹，每个又包含有几十个c文件和h文件。切忌一开始就将精力放在细节上，开始我通过c文件的名字寻找我觉得重要的代码，然后逐行逐字地看，花了很多时间，完全摸不着方向，挫败感很强。
* 后来经师兄的提醒，逐个看c文件，只关注『函数名』和是否为内部函数，『头文件、变量、输入参数、输出参数』都忽略掉，并根据注释或函数名大致确定每个函数的功能，整理成文档。
* 经过第4部，就能知道哪些c文件是核心，哪些函数是核心中的核心，然后从某一个函数开始，跟踪到无法跟踪下去为止，可以用『树状结构』记录这些调用关系，经过这步后会对代码整个的操作流程有个整体的认识。这个过程当中需要留意源码中的注释，那是很多前辈的智慧，他们将思考、疑问、心得都写下来，今天看到了一句注释『This is the brains of the operation.』，激动啊。因为还不清楚『数据结构』，所以这时的认识很笼统。
* 从核心c文件包含的头文件开始，梳理『数据结构』，LinuxCNC里面有大量的结构体，建议将重要的『数据结构』整理出来。
* 接下来goto第5步，不过要挖的细一些，碰到不懂的『数据结构』，goto第6步，有啥新心得体会都记录下来，until你觉得看懂了源代码

# 对于OOP

如果是 OOP，首选当然是 UML 建模了，边读源码边画图，好处多多。

包图 - 基本架构组织，分层

类图 - 核心对象、接口，依赖关系

交互图 -  执行流程，消息走向，调用关系

活动图（加强版流程图） - 核心算法，任务流程

状态图。。。

而且在图形旁边加文本注释，也是很优雅。

作者：Agile2-张恂老师
链接：https://www.zhihu.com/question/22129281/answer/53258520
来源：知乎
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
